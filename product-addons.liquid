{% comment %}
Product Add-ons Block - Complete implementation  
Supports both data-variant-id and data-addon-variant-id for backward compatibility
Supports product_list (product picker) and addon_products (handles) for flexibility
{% endcomment %}

{% liquid
  # Get both product selection methods
  assign addon_products_from_picker = block.settings.product_list
  assign addon_products_handles_string = block.settings.addon_products | strip
  
  # Determine which method has products
  # product_list is an array - check its size
  # addon_products is a string - check if it's blank after stripping whitespace
  assign use_product_list = false
  if addon_products_from_picker.size > 0
    assign use_product_list = true
    assign addon_products = addon_products_from_picker
  elsif addon_products_handles_string != blank
    assign use_product_list = false
    assign addon_products_handles = addon_products_handles_string | split: ','
  endif
  
  # Get display settings
  assign show_images = block.settings.show_images
  assign show_descriptions = block.settings.show_descriptions
  assign image_size = block.settings.image_size | default: 'small'
  assign layout_style = block.settings.layout_style | default: 'compact'
  
  # Determine if we should render
  assign should_render = false
  if use_product_list
    if addon_products.size > 0
      assign should_render = true
    endif
  else
    if addon_products_handles.size > 0
      assign should_render = true
    endif
  endif
%}

{% if should_render %}
<div id="product-addons-{{ section.id }}" class="product-addons addon-options layout-{{ layout_style }}"
     style="--addon-title-color: {{ block.settings.title_color | default: '#232323' }};
            --addon-border-color: {{ block.settings.border_color | default: '#eee' }};
            --addon-selected-bg: {{ block.settings.selected_background | default: '#f0f8ff' }};
            --addon-selected-border: {{ block.settings.selected_border_color | default: '#232323' }};">
  
  {% if block.settings.addons_title != blank %}
    <h4 class="product-addons__title">{{ block.settings.addons_title }}</h4>
  {% endif %}
  
  {% if block.settings.addons_description != blank %}
    <p class="product-addons__description">{{ block.settings.addons_description }}</p>
  {% endif %}
  
  <div class="product-addons__list">
    {% if use_product_list %}
      {% comment %} New product_list method {% endcomment %}
      {% for addon in addon_products %}
        {% if addon.id != blank %}
          {% assign addon_variant = addon.selected_or_first_available_variant %}
          {% assign is_available = addon.available %}
          
          <label class="product-addons__item {% unless is_available %}unavailable{% endunless %}" 
                 data-addon-item
                 data-product-id="{{ addon.id }}">
            
            <div class="product-addons__checkbox-wrapper">
              <input
                type="checkbox"
                class="product-addons__checkbox"
                data-variant-id="{{ addon_variant.id }}"
                data-addon-variant-id="{{ addon_variant.id }}"
                data-addon-price="{{ addon_variant.price }}"
                data-addon-title="{{ addon.title | escape }}"
                {% unless is_available %}disabled{% endunless %}
              />
              <span class="product-addons__checkmark"></span>
            </div>
            
            {% if show_images and addon.featured_image %}
              <div class="product-addons__image image-size-{{ image_size }}">
                {% liquid
                  # Use 2x resolution for retina displays
                  if image_size == 'small'
                    assign img_width = 80
                    assign display_size = 40
                  elsif image_size == 'medium'
                    assign img_width = 120
                    assign display_size = 60
                  else
                    assign img_width = 160
                    assign display_size = 80
                  endif
                %}
                <img src="{{ addon.featured_image | image_url: width: img_width }}" 
                     alt="{{ addon.title | escape }}"
                     width="{{ display_size }}"
                     height="{{ display_size }}"
                     loading="lazy">
              </div>
            {% endif %}
            
            <div class="product-addons__content">
              <span class="product-addons__label">
                {{ addon.title }}
                {% unless is_available %}
                  <span class="product-addons__sold-out">(Sold Out)</span>
                {% endunless %}
              </span>
              
              {% if show_descriptions and addon.description != blank %}
                <span class="product-addons__excerpt">{{ addon.description | strip_html | truncate: 80 }}</span>
              {% endif %}
              
              <span class="product-addons__price">
                {% if addon_variant.compare_at_price > addon_variant.price %}
                  <s class="product-addons__compare-price">{{ addon_variant.compare_at_price | money }}</s>
                {% endif %}
                + {{ addon_variant.price | money }}
              </span>
            </div>
            
          </label>
        {% endif %}
      {% endfor %}
    {% else %}
      {% comment %} Legacy addon_products method with handles {% endcomment %}
      {% for addon_handle in addon_products_handles %}
        {% assign addon_handle = addon_handle | strip %}
        {% assign addon = all_products[addon_handle] %}
        
        {% if addon.id != blank %}
          {% assign addon_variant = addon.selected_or_first_available_variant %}
          {% assign is_available = addon.available %}
          
          <label class="product-addons__item {% unless is_available %}unavailable{% endunless %}" 
                 data-addon-item
                 data-product-id="{{ addon.id }}">
            
            <div class="product-addons__checkbox-wrapper">
              <input
                type="checkbox"
                class="product-addons__checkbox"
                data-variant-id="{{ addon_variant.id }}"
                data-addon-variant-id="{{ addon_variant.id }}"
                data-addon-price="{{ addon_variant.price }}"
                data-addon-title="{{ addon.title | escape }}"
                {% unless is_available %}disabled{% endunless %}
              />
              <span class="product-addons__checkmark"></span>
            </div>
            
            {% if show_images and addon.featured_image %}
              <div class="product-addons__image image-size-{{ image_size }}">
                {% liquid
                  # Use 2x resolution for retina displays
                  if image_size == 'small'
                    assign img_width = 80
                    assign display_size = 40
                  elsif image_size == 'medium'
                    assign img_width = 120
                    assign display_size = 60
                  else
                    assign img_width = 160
                    assign display_size = 80
                  endif
                %}
                <img src="{{ addon.featured_image | image_url: width: img_width }}" 
                     alt="{{ addon.title | escape }}"
                     width="{{ display_size }}"
                     height="{{ display_size }}"
                     loading="lazy">
              </div>
            {% endif %}
            
            <div class="product-addons__content">
              <span class="product-addons__label">
                {{ addon.title }}
                {% unless is_available %}
                  <span class="product-addons__sold-out">(Sold Out)</span>
                {% endunless %}
              </span>
              
              {% if show_descriptions and addon.description != blank %}
                <span class="product-addons__excerpt">{{ addon.description | strip_html | truncate: 80 }}</span>
              {% endif %}
              
              <span class="product-addons__price">
                {% if addon_variant.compare_at_price > addon_variant.price %}
                  <s class="product-addons__compare-price">{{ addon_variant.compare_at_price | money }}</s>
                {% endif %}
                + {{ addon_variant.price | money }}
              </span>
            </div>
            
          </label>
        {% elsif block.settings.show_debug %}
          <div class="product-addons__debug">
            ⚠️ Product with handle "{{ addon_handle }}" not found
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
</div>
{% elsif block.settings.show_debug %}
  <div class="product-addons__debug">
    ⚠️ No add-on products configured. Please select products in the theme editor.
  </div>
{% endif %}